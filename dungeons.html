<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Dungeon Simulator</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="res/favicon.png"/>

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>
        <script src="vendor/js/sentry.bundle.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>
        <script src="js/lang.js"></script>

        <script src="js/core/util.js"></script>
        <script src="js/core/playa.js"></script>
        <script src="js/core/core.js"></script>
        <script src="js/plugins.js"></script>
        <script src="js/core/idb.js"></script>
        <script src="js/core/ast.js"></script>
        <script src="js/stats/settings.js"></script>
        <script src="endpoint/endpoint.js"></script>

        <script src="js/changelog.js"></script>
        <script src="js/sim/dungeon_data.js"></script>
        <script src="js/sim/dungeons.js"></script>
        <script src="js/views.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">

        <script type="text/javascript">
            LOGICAL_PROCS = (navigator || {}).hardwareConcurrency || 4;
        </script>

        <style>
            .bordered .fields:last-of-type {
                margin-bottom: 0;
            }

            .bordered {
                padding: 0.5em;
                margin-bottom: 0.5em;
            }

            .bordered-simple {
                margin-bottom: 0.35em;
                padding-top: 0.5em !important;
                padding-bottom: 0.5em !important;
                margin-right: 1em;
                margin-left: 1em;
            }

            .bnone {
                border: 1px solid transparent;
            }

            .bone {
                border: 1px solid orange;
            }

            .btwo {
                border: 1px solid purple;
            }

            .bthree {
                border: 1px solid blue;
            }

            .bfour {
                border: 1px solid red;
            }

            .bfive {
                border: 1px solid green;
            }

            .bsix {
                border: 1px solid pink;
            }

            .spaced {
                margin-top: 2em !important;
            }

            .selectable {
                -moz-user-select: -moz-none;
                -khtml-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                padding-bottom: 0.25em !important;
                padding-top: 0.25em !important;
                height: 4em;
            }

            .selectable div {
                padding: 0 !important;
            }

            .selectable-header div {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            .selected {
                background-color: rgba(0, 0, 0, 0.1);
                cursor: pointer;
            }

            .nselected {
                cursor: pointer;
            }

            .inactive {
                opacity: 50%;
            }

            #sim-players1 {
                align-content: flex-start;
                padding-bottom: 0.75em;
            }

            .class-picture {
                 margin-left: -0.75em !important;
                 margin-right: 0.5em !important;
            }

            .class-none {
                margin-left: 1.75em;
            }

            .footer {
                position: fixed;
                left: 1em;
                bottom: 1em;
            }

            .statistics-module {
                position: absolute;
                left: 2em;
                top: 5em;
                width: 15em;
                z-index: 99;
            }

            body {
                overflow-y: hidden !important;
            }

            .text .boss-image {
                top: -0.75em !important;
                right: -0.75em !important;
            }

            .boss-rune {
                font-size: 70%;
                margin-left: 0.25em;
                position: absolute;
                right: 3.5em;
                bottom: 0;
            }

            div.text .boss-rune {
                bottom: -1.1em;
                right: 2.5em;
            }

            #boss-list .text, #available-list .text {
                width: 100%;
            }

            #boss-list .menu, #available-list .menu {
                overflow-y: scroll;
            }

            #load-stats {
                margin-bottom: 0.5em;
            }

            #stats-list > div {
                font-size: 90%;
            }

            #available-list .boss-dungeon-name {
                font-size: 80%;
                position: absolute;
                top: -0.75em;
            }

            #available-list .boss-name {
                font-size: 90%;
                position: absolute;
                top: 0.5em;
            }

            #available-list .menu .boss-dungeon-name {
                top: 0.25em;
            }

            #available-list .menu .boss-name {
                top: 1.5em;
            }

            #available-list .boss-rune {
                font-size: 70%;
                position: absolute;
                right: 3.5em;
                top: -0.85em;
            }

            #available-list .menu .boss-rune {
                top: 0.35em;
            }

            #winchart.faded-out {
                opacity: 0.5 !important;
            }

            .ui.dimmer {
                overflow-y: hidden !important;
            }

            body.dimmed {
                margin-right: 0 !important;
            }
        </style>
    </head>
    <body class="margin-none-bottom">
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item"><a class="css-a-blank" href="index.html">SFTools</a></div>
            <a class="item" href="https://github.com/HafisCZ/sf-tools/wiki/%5BWIP%5D-Tools-Overview#dungeon-simulator" target="_blank"><i class="ui icon book"></i> Wiki - How to use</a>
        </div>

        <div class="footer">
            <b>Notice:</b> <span style="font-size: 90%;">The sim should be very accurate, but sometimes you might win a fight in-game that the sim shows as impossible.<br/>
            In that case save the fight in a HAR file and send to mar21#4673 in <a target="_blank" href="https://discord.gg/XWfSwe3">S&F Tavern</a>.</span>
        </div>

        <div class="statistics-module" id="stats-module">
            <div class="ui fluid basic gray button" id="load-stats"><i class="sync alternate icon"></i>Poll saved characters</div>
            <div id="stats-list">
                <!-- LIST -->
            </div>
        </div>

        <div class="paste-target" onpaste="console.log">
            Click here and press <b>CTRL&nbsp;+&nbsp;V</b> to paste into the simulator
        </div>

        <div class="ui main container">
            <div class="ui two columns grid">
                <!-- Player edit field -->
                <div class="column">
                    <div class="ui form" id="sim-editor">
                        <div class="bordered bone">
                            <div class="field">
                                <label>Name</label>
                                <input class="text-center" disabled type="text" data-path="Name">
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label>Class</label>
                                    <div class="ui search selection compact dropdown" data-path="Class">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Mask</label>
                                    <div class="ui selection compact dropdown" data-path="Mask">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Level</label>
                                    <input class="text-center" type="text" data-path="Level" placeholder="1 - 700">
                                </div>
                            </div>
                            <div class="five fields">
                                <div class="field">
                                    <label>Strength</label>
                                    <input class="text-center" type="text" data-path="Strength.Total">
                                </div>
                                <div class="field">
                                    <label>Dexterity</label>
                                    <input class="text-center" type="text" data-path="Dexterity.Total">
                                </div>
                                <div class="field">
                                    <label>Intelligence</label>
                                    <input class="text-center" type="text" data-path="Intelligence.Total">
                                </div>
                                <div class="field">
                                    <label>Constitution</label>
                                    <input class="text-center" type="text" data-path="Constitution.Total">
                                </div>
                                <div class="field">
                                    <label>Luck</label>
                                    <input class="text-center" type="text" data-path="Luck.Total">
                                </div>
                            </div>
                        </div>
                        <div class="bordered btwo">
                            <div class="five fields">
                                <div class="field">
                                    <label>Min</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn1.DamageMin" placeholder="Item Min">
                                </div>
                                <div class="field">
                                    <label>Max</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn1.DamageMax" placeholder="Item Max">
                                </div>
                                <div class="field">
                                    <label>Crit</label>
                                    <div class="ui selection compact dropdown" data-path="Items.Wpn1.HasEnchantment">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Rune</label>
                                    <div class="ui selection compact dropdown" data-path="Items.Wpn1.AttributeTypes.2">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label><br/></label>
                                    <input class="text-center" type="text" data-path="Items.Wpn1.Attributes.2" placeholder="0 - 60">
                                </div>
                            </div>
                        </div>
                        <div class="bordered bthree" data-optional="Weapon2">
                            <div class="five fields">
                                <div class="field">
                                    <label>Min</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn2.DamageMin" placeholder="Item Min">
                                </div>
                                <div class="field">
                                    <label>Max</label>
                                    <input class="text-center" type="text" data-path="Items.Wpn2.DamageMax" placeholder="Item Max">
                                </div>
                                <div class="field">
                                    <label>Crit</label>
                                    <div class="ui selection compact dropdown" data-path="Items.Wpn2.HasEnchantment">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Rune</label>
                                    <div class="ui selection compact dropdown" data-path="Items.Wpn2.AttributeTypes.2">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label><br/></label>
                                    <input class="text-center" type="text" data-path="Items.Wpn2.Attributes.2" placeholder="0 - 60">
                                </div>
                            </div>
                        </div>
                        <div class="bordered bfour">
                            <div class="four fields">
                                <div class="field">
                                    <label>Armor</label>
                                    <input class="text-center" type="text" data-path="Armor" placeholder="Armor points">
                                </div>
                                <div class="field">
                                    <label>Shield</label>
                                    <div class="ui selection compact dropdown" data-path="BlockChance">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Fire</label>
                                    <input class="text-center" type="text" data-path="Runes.ResistanceFire" placeholder="0 - 75">
                                </div>
                                <div class="field">
                                    <label>Cold</label>
                                    <input class="text-center" type="text" data-path="Runes.ResistanceCold" placeholder="0 - 75">
                                </div>
                                <div class="field">
                                    <label>Lightning</label>
                                    <input class="text-center" type="text" data-path="Runes.ResistanceLightning" placeholder="0 - 75">
                                </div>
                            </div>
                        </div>
                        <div class="bordered bfive">
                            <div class="three fields">
                                <div class="field">
                                    <label>Portal Health</label>
                                    <input class="text-center" type="text" data-path="Dungeons.Player" placeholder="0 - 50">
                                </div>
                                <div class="field">
                                    <label>Rune Health</label>
                                    <input class="text-center" type="text" data-path="Runes.Health" placeholder="0 - 15">
                                </div>
                                <div class="field">
                                    <label>Life Potion</label>
                                    <div class="ui selection compact dropdown" data-path="Potions.Life">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bordered bsix">
                            <div class="three fields">
                                <div class="field">
                                    <label>Portal Damage</label>
                                    <input class="text-center" type="text" data-path="Dungeons.Group" placeholder="0 - 50">
                                </div>
                                <div class="field">
                                    <label>Gladiator (0 - 15)</label>
                                    <input class="text-center" type="text" data-path="Fortress.Gladiator" placeholder="0 - 15">
                                </div>
                                <div class="field">
                                    <label>Shadow of the Cowboy</label>
                                    <div class="ui selection compact dropdown" data-path="Items.Hand.HasEnchantment">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Player list -->
                <div class="column">
                    <div class="ui grid">
                        <div class="row">
                            <div class="three wide column">
                                <button class="ui fluid basic icon button" data-position="bottom center" data-tooltip="Copy current" id="sim-copyCurrent"><i class="outline copy icon"></i> 1</button>
                            </div>
                            <div class="five wide column">
                                <div class="ui small form">
                                    <div class="two fields">
                                        <div class="field" data-position="bottom center" data-tooltip="Simulator threads. Keep this number BELOW your processor core count!">
                                            <input class="text-center fluid" type="text" id="sim-threads" value="2">
                                        </div>
                                        <div class="field" data-position="bottom center" data-tooltip="Amount of iterations per thread.">
                                            <span style="position: absolute; top: 0.5em; left: -0.25em;">x</span>
                                            <input class="text-center fluid" type="text" id="sim-iterations" value="5000">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="six wide column">
                                <button class="ui fluid button" type="submit" id="sim-run">Simulate</button>
                            </div>
                            <div class="two wide column" style="padding-left: 0;">
                                <button class="ui fluid button disabled" type="submit" id="sim-run-all">All</button>
                            </div>
                        </div>
                        <div class="row padding-none">
                            <div class="eight wide text-center column">
                                Player
                            </div>
                            <div class="eight wide text-center column">
                                Enemy
                            </div>
                        </div>
                        <div class="row padding-none">
                            <div class="sixteen wide column">
                                <hr/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="eight wide column">
                                <div class="ui middle aligned grid" id="sim-players1">

                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="ui form" style="margin-top: -0.4em;">
                                    <div class="field">
                                        <div class="ui fluid search selection dropdown" id="dungeon-list">
                                          <div class="text"></div>
                                          <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                    <div class="field" style="margin-top: 1.25em;">
                                        <div class="ui fluid search selection dropdown" id="boss-list">
                                          <div class="text"></div>
                                          <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                    <div class="field disabled" style="margin-top: 3.7em;">
                                        <label>Currently open dungeons</label>
                                        <div class="ui fluid search selection dropdown" id="available-list">
                                          <div class="text"></div>
                                          <i class="dropdown icon"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="padding-top: 0;">
                            <div class="sixteen wide column" style="position: relative;">
                                <div style="position: absolute; left: 0.5em; bottom: -1.5em; font-size: 80%; opacity: 50%;">Boss HP Left</div>
                                <div style="position: absolute; left: 37%; bottom: -1.5em; font-size: 80%; opacity: 50%;">- Distribution for selected amount of tries -</div>
                                <canvas id="winchart" style="width: 100%; height: 17.75em;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-modal" class="ui mini modal">
          <div class="header">Results</div>
          <div style="padding-left: 1em; padding-right: 1em; border-bottom: 1px solid rgba(34,36,38,.15)">
              <canvas id="list-winchart" style="width: 100%;"></canvas>
          </div>
          <div class="content" style="max-height: 70vh; overflow-y: auto;">

          </div>
        </div>

        <script type="text/javascript">
            window.addEventListener('load', function () {
                if (new Date().getMonth() == 3 && new Date().getDate() == 1) {
                    let randomString = orig => {
                        let str = ''
                        for (let i = 0; i < orig.length; i++) {
                            if (/[a-z]/.test(orig[i])) {
                                str += 'abcdefghijklmnopqrstuvwxyz'.charAt(Math.floor(Math.random() * 26));
                            } else if (/[A-Z]/.test(orig[i])) {
                                str += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.charAt(Math.floor(Math.random() * 26));
                            } else {
                                str += orig[i];
                            }
                        }
                        return str;
                    }

                    for (let [k, v] of Object.entries(DUNGEON_DATA)) {
                        v.name = randomString(v.name);
                        for (let [k2, v2] of Object.entries(v.floors)) {
                            delete v.floors[k2];
                            v.floors[randomString(k2)] = v2;
                        }
                    }
                }

                function toggleAll (dis) {
                    if (dis) {
                        PopupController.open(LoaderPopup);
                    } else {
                        PopupController.close(LoaderPopup);
                    }
                }

                let ignoreChanges = false;
                function withoutUpdate (func) {
                    ignoreChanges = true;
                    func();
                    ignoreChanges = false;
                }

                $('#sim-threads').captiveInputField('dungeon_sim/threads', 4, v => !isNaN(v) && v >= 1);
                $('#sim-iterations').captiveInputField('dungeon_sim/iterations', 5000, v => !isNaN(v) && v >= 1);

                const EditorController = new (class {
                    constructor () {
                        this.fields = {
                            name: new Field('[data-path="Name"]', ''),
                            class: new Field('[data-path="Class"]', '1'),
                            mask: new Field('[data-path="Mask"]', '0'),
                            level: new Field('[data-path="Level"]', '', Field.isPlayerLevel),
                            armor: new Field('[data-path="Armor"]', '', Field.isNumber),

                            resistance_fire: new Field('[data-path="Runes.ResistanceFire"]', '', Field.isResistanceRune),
                            resistance_cold: new Field('[data-path="Runes.ResistanceCold"]', '', Field.isResistanceRune),
                            resistance_lightning: new Field('[data-path="Runes.ResistanceLightning"]', '', Field.isResistanceRune),

                            portal_hp: new Field('[data-path="Dungeons.Player"]', '', Field.isDungeon),
                            portal_damage: new Field('[data-path="Dungeons.Group"]', '', Field.isDungeon),

                            runes_health: new Field('[data-path="Runes.Health"]', '', Field.isHealthRune),
                            gladiator: new Field('[data-path="Fortress.Gladiator"]', '', Field.isGladiator),
                            potion_life: new Field('[data-path="Potions.Life"]', '0'),
                            enchantment: new Field('[data-path="Items.Hand.HasEnchantment"]', 'false'),
                            shield: new Field('[data-path="BlockChance"]', '25'),

                            str: new Field('[data-path="Strength.Total"]', '', Field.isNumber),
                            dex: new Field('[data-path="Dexterity.Total"]', '', Field.isNumber),
                            int: new Field('[data-path="Intelligence.Total"]', '', Field.isNumber),
                            con: new Field('[data-path="Constitution.Total"]', '', Field.isNumber),
                            lck: new Field('[data-path="Luck.Total"]', '', Field.isNumber),

                            weapon1_min: new Field('[data-path="Items.Wpn1.DamageMin"]', '', Field.isWeaponDamage),
                            weapon1_max: new Field('[data-path="Items.Wpn1.DamageMax"]', '', Field.isWeaponDamage),
                            weapon1_enchantment: new Field('[data-path="Items.Wpn1.HasEnchantment"]', 'false'),
                            weapon1_rune: new Field('[data-path="Items.Wpn1.AttributeTypes.2"]', '0'),
                            weapon1_value: new Field('[data-path="Items.Wpn1.Attributes.2"]', '', Field.isDamageRune),

                            weapon2_min: new Field('[data-path="Items.Wpn2.DamageMin"]', '', Field.isWeaponDamage),
                            weapon2_max: new Field('[data-path="Items.Wpn2.DamageMax"]', '', Field.isWeaponDamage),
                            weapon2_enchantment: new Field('[data-path="Items.Wpn2.HasEnchantment"]', 'false'),
                            weapon2_rune: new Field('[data-path="Items.Wpn2.AttributeTypes.2"]', '0'),
                            weapon2_value: new Field('[data-path="Items.Wpn2.Attributes.2"]', '', Field.isDamageRune)
                        };

                        this.fields['class'].$object.dropdown({
                            preserveHTML: true,
                            values: Object.entries(ClassMap).map((e) => {
                                return {
                                    name: `<img class="ui centered image class-picture" src="res/class${ e[0] }.png"><span>${ e[1] }</span>`,
                                    value: e[0]
                                };
                            })
                        }).dropdown('setting', 'onChange', (value, text) => {
                            if (value == 4) {
                                $('[data-optional="Weapon2"]').show();
                            } else {
                                $('[data-optional="Weapon2"]').hide();
                            }

                            this.fields['shield'].show(value == 1);
                            this.fields['mask'].show(value == 8);
                        }).dropdown('set selected', '1');

                        this.fields['mask'].$object.dropdown({
                            preserveHTML: true,
                            values: [
                                {
                                    name: 'None',
                                    value: 0
                                },
                                {
                                    name: '<img class="ui centered image class-picture" src="res/mask1.png"><span>Bear</span>',
                                    value: 1
                                },
                                {
                                    name: '<img class="ui centered image class-picture" src="res/mask2.png"><span>Cat</span>',
                                    value: 2
                                }
                            ]
                        }).dropdown('set selected', '0');

                        this.fields['potion_life'].$object.dropdown({
                            values: [
                                {
                                    name: 'No',
                                    value: 0
                                },
                                {
                                    name: 'Yes',
                                    value: 25
                                }
                            ]
                        }).dropdown('set selected', '0');

                        this.fields['shield'].$object.dropdown({
                            values: [
                                {
                                    name: 'No',
                                    value: 0
                                },
                                {
                                    name: 'Yes',
                                    value: 25
                                }
                            ]
                        }).dropdown('set selected', '25');

                        this.fields['weapon1_rune'].$object.dropdown({
                            values: [
                                {
                                    name: 'None',
                                    value: 0
                                },
                                {
                                    name: 'Fire',
                                    value: 40
                                },
                                {
                                    name: 'Cold',
                                    value: 41
                                },
                                {
                                    name: 'Lightning',
                                    value: 42
                                }
                            ]
                        }).dropdown('set selected', '0');

                        this.fields['weapon2_rune'].$object.dropdown({
                            values: [
                                {
                                    name: 'None',
                                    value: 0
                                },
                                {
                                    name: 'Fire',
                                    value: 40
                                },
                                {
                                    name: 'Cold',
                                    value: 41
                                },
                                {
                                    name: 'Lightning',
                                    value: 42
                                }
                            ]
                        }).dropdown('set selected', '0');

                        this.fields['enchantment'].$object.dropdown({
                            values: [
                                {
                                    name: 'No',
                                    value: false
                                },
                                {
                                    name: 'Yes',
                                    value: true
                                }
                            ]
                        }).dropdown('set selected', 'false');

                        this.fields['weapon1_enchantment'].$object.dropdown({
                            values: [
                                {
                                    name: 'No',
                                    value: false
                                },
                                {
                                    name: 'Yes',
                                    value: true
                                }
                            ]
                        }).dropdown('set selected', 'false');

                        this.fields['weapon2_enchantment'].$object.dropdown({
                            values: [
                                {
                                    name: 'No',
                                    value: false
                                },
                                {
                                    name: 'Yes',
                                    value: true
                                }
                            ]
                        }).dropdown('set selected', 'false');

                        for (let field of Object.values(this.fields)) {
                            field.setListener(() => this.changeListener());
                        }

                        this.enableListener = true;
                    }

                    changeListener () {
                        if (this.valid() && this.enableListener) {
                            saveEditor();
                            settingsChanged();
                        }
                    }

                    fill (object, index) {
                        this.enableListener = false;

                        if (object) {
                            for (var [key, field] of Object.entries(this.fields)) {
                                field.set(getObjectAt(object, field.path()));
                            }
                        } else {
                            for (var [key, field] of Object.entries(this.fields)) {
                                field.clear();
                            }
                        }

                        if (index > 0) {
                            this.fields['class'].set(index);
                        }

                        this.fields['class'].toggle(index == 0);
                        this.fields['gladiator'].toggle(index == 0);
                        this.fields['portal_hp'].toggle(index == 0);
                        this.fields['portal_damage'].toggle(index == 0);
                        this.fields['potion_life'].toggle(index == 0);
                        this.fields['level'].toggle(index == 0);
                        this.fields['shield'].show(object.Class == 1 && index == 0);
                        this.fields['name'].set(['Player', 'Bert', 'Mark', 'Kunigunde'][index]);

                        this.enableListener = true;
                    }

                    read () {
                        var object = new SFPlayer();
                        for (var [key, field] of Object.entries(this.fields)) {
                            setObjectAt(object, field.path(), field.get());
                        }

                        return object;
                    }

                    valid () {
                        var ass = this.fields['class'].get() != 4;
                        for (var [key, field] of Object.entries(this.fields)) {
                            if (ass && ['weapon2_min', 'weapon2_max', 'weapon2_value'].includes(key)) {
                                continue;
                            }

                            if (!field.valid()) {
                                return false;
                            }
                        }

                        return true;
                    }

                    genEmpty (defClass = 1) {
                        var object = new SFPlayer();
                        for (var [key, field] of Object.entries(this.fields)) {
                            setObjectAt(object, field.path(), field.defaultValue);
                        }

                        object.Class = defClass;

                        return object;
                    }
                })();

                // On paste event handler
                var players = [ EditorController.genEmpty(), EditorController.genEmpty(1), EditorController.genEmpty(2), EditorController.genEmpty(3) ];

                var boss_current = null;
                var boss = null;
                var dungeon_current = null;
                var dungeon = null;
                var availableBosses = null;
                var log = window.location.href.includes('log');

                function settingsChanged () {
                    $('#winchart').addClass('faded-out');
                }

                function getBossData (data, name = '') {
                    return {
                        ArmorAuto: data.armor ? 0 : (dungeon.auto_armor_multiplier || 1),
                        Armor: data.armor,
                        Class: data.class,
                        Mask: 0,
                        Name: name,
                        Level: data.level,
                        AutoHealth: data.health,
                        Identifier: 999,
                        Strength: { Total: data.str },
                        Dexterity: { Total: data.dex },
                        Intelligence: { Total: data.int },
                        Constitution: { Total: data.con },
                        Luck: { Total: data.lck },
                        Dungeons: { Player: 0, Group: 0 },
                        Fortress: { Gladiator: data.gladiator || 0 },
                        Potions: { Life: 0 },
                        Runes: {
                            Health: 0,
                            ResistanceFire: data.runes && data.runes.res ? data.runes.res[0] : 0,
                            ResistanceCold: data.runes && data.runes.res ? data.runes.res[1] : 0,
                            ResistanceLightning: data.runes && data.runes.res ? data.runes.res[2] : 0,
                        },
                        Items: {
                            Hand: { HasEnchantment: data.class == 6 },
                            Wpn1: {
                                AttributeTypes: { 2: data.runes ? data.runes.type : 0 },
                                Attributes: { 2: data.runes ? data.runes.damage : 0 },
                                DamageMax: data.max,
                                DamageMin: data.min,
                                HasEnchantment: false
                            },
                            Wpn2: {
                                AttributeTypes: { 2: data.runes ? data.runes.type : 0 },
                                Attributes: { 2: data.runes ? data.runes.damage : 0 },
                                DamageMax: data.ass ? data.max : 0,
                                DamageMin: data.ass ? data.min : 0,
                                HasEnchantment: false
                            }
                        }
                    };
                }

                $('#dungeon-list').dropdown({
                    values: Object.entries(DUNGEON_DATA).map(([ id, dungeon ]) => {
                        return {
                            name: dungeon.shadow ? `<span style="text-shadow:0px 0px 8px #390074;">${ dungeon.name }<span>` : dungeon.name,
                            value: id,
                            disabled: Object.keys(dungeon.floors).length == 0
                        };
                    })
                }).dropdown('setting', 'onChange', (value, text) => {
                    dungeon_current = value;
                    dungeon = DUNGEON_DATA[value];

                    $('#boss-list').dropdown({
                        values: Object.entries(dungeon.floors).map(([ name, _boss ]) => {
                            return {
                                name: `<span${ dungeon.shadow ? ' style="text-shadow:0px 0px 8px #390074;"' : '' }>
                                           <img class="ui centered image boss-image" style="position: absolute; right: 0; height: 2.5em; top: 0; width: 2.5em;" src="res/class${ _boss.class }.png">
                                               ${ _boss.pos }. ${ name }
                                               ${ _boss.runes ? `
                                                   <span class="boss-rune">
                                                       ${ _boss.runes.damage } ${ ['F', 'C', 'L'][ _boss.runes.type - 40 ] } / ${ (_boss.runes.res || ['?', '?', '?']).map((res, i) => `${ res } ${ [ 'F', 'C', 'L' ][i] }`).join('&nbsp; ') }
                                                   </span>
                                               ` : '' }
                                       <span>`,
                                value: name
                            };
                        })
                    }).dropdown('setting', 'onChange', (value, text) => {
                        if (!ignoreChanges) {
                            $('#available-list').dropdown('clear');
                        }

                        settingsChanged();

                        dungeon = DUNGEON_DATA[dungeon_current];
                        boss = getBossData(dungeon.floors[value], value);
                        boss_current = boss;
                    }).dropdown('set selected', Object.keys(dungeon.floors)[0]);
                    show();
                }).dropdown('set selected', '1');

                var selected = 0;

                $(document.body).on('paste', function (event) {
                    if (event.target.type != 'text') {
                        try {
                            showData(JSON.parse(event.originalEvent.clipboardData.getData('text')));
                        } catch (e) {
                            // Do nothing
                        }
                    }
                });

                $('#sim-editor input').on('paste', function (event) { event.stopPropagation(); });

                function loadEditor (data) {
                    SFItem.forceCorrectRune(data.Items.Wpn1);
                    SFItem.forceCorrectRune(data.Items.Wpn2);

                    if (data.Class == 1 && typeof data.BlockChance == 'undefined') data.BlockChance = data.Items.Wpn2.DamageMin;
                    if (data.Class != 4) data.Items.Wpn2 = SFItem.empty();
                    if (data.Underworld) data.Fortress.Gladiator = data.Underworld.Gladiator;

                    if (selected > 0) {
                        for (var key of ['gladiator', 'level', 'portal_hp', 'portal_damage', 'potion_life']) {
                            var path = EditorController.fields[key].path();
                            setObjectAt(data, path, getObjectAt(players[0], path));
                        }
                    }

                    EditorController.fill(data, selected);
                }

                function saveEditor () {
                    if (EditorController.valid()) {
                        var obj = EditorController.read();
                        if (selected == 0) {
                            for (var key of ['gladiator', 'level', 'portal_hp', 'portal_damage', 'potion_life']) {
                                var path = EditorController.fields[key].path();

                                setObjectAt(players[1], path, getObjectAt(obj, path));
                                setObjectAt(players[2], path, getObjectAt(obj, path));
                                setObjectAt(players[3], path, getObjectAt(obj, path));
                            }
                        }

                        players[selected] = obj;
                    }
                }

                // Copy buttons
                $('#sim-copyCurrent').click(() => copyText(JSON.stringify(EditorController.read())));

                // Show fighters
                function show () {
                    var content1 = '';

                    for (var i = 0; i < 4; i++) {
                        content1 += `
                            <div class="row selectable ${ selected == i ? 'selected' : 'nselected' }" data-index="${ i }">
                                <div class="four wide text-center column">
                                    <img class="ui medium centered image" style="width: 50px; opacity: ${ i == 0 || dungeon.shadow ? '100' : '25' }%;" src="res/portrait${ i ? i : '' }.png">
                                </div>
                                <div class="eight wide column text-center">
                                    <b>${ ['You', 'Bert', 'Mark', 'Kunigunde'][i] }</b>
                                </div>
                                <div class="four wide column">
                                </div>
                            </div>
                        `;
                    }

                    $('#sim-players1').html(content1);

                    $('[data-index]').click(function () {
                        select(Number($(this).attr('data-index')));
                    });
                }

                function select (index) {
                    selected = index;

                    EditorController.fill(players[selected], selected);
                    show();
                }

                select(0);

                const chart = new Chart($('#winchart'), {
                    type:'line',data:{datasets:[{fill:!1,borderWidth:1.5,data:[]}]},options:{title:{display:!0},legend:{display:!1},scales:{yAxes:[{display:!0,ticks:{min:0,max:100,padding:10,stepSize:20,callback:function(value,index,values){return `${ value }%`}}}],xAxes:[{display:!1}]},tooltips:{enabled:!1},animation:{duration:0},events:[],hover:{animationDuration:0,},showTooltips:!1,responsiveAnimationDuration:0,elements:{line:{borderColor:'black',tension:0},point:{radius:0}}}
                });

                const chartList = new Chart($('#list-winchart'), {
                    type:'line',data:{datasets:[{fill:!1,borderWidth:1.5,data:[]}]},options:{title:{display:!0},legend:{display:!1},scales:{yAxes:[{display:!0,ticks:{min:0,max:100,padding:10,stepSize:20,display:!1}}],xAxes:[{display:!1}]},tooltips:{enabled:!1},animation:{duration:0},events:[],hover:{animationDuration:0,},showTooltips:!1,responsiveAnimationDuration:0,elements:{line:{borderColor:'black',tension:0},point:{radius:0}}}
                });

                function showData (data) {
                    let oldSelected = selected;
                    if (Array.isArray(data)) {
                        for (let i = 0; i < 4; i++) {
                            selected = i;
                            loadEditor(data[i]);
                            saveEditor();
                        }

                        selected = oldSelected;
                        loadEditor(data[selected]);

                        show();
                    } else if (data.Class) {
                        loadEditor(data);
                        saveEditor();
                    }

                    settingsChanged();
                }

                var DUNGEON_ARR_TO_DID = [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 16, 17, 19, 20, 21 ];
                function getDungeonEnemyAt (dungeon, isShadow, enemyIndex) {
                    if (enemyIndex < 0) {
                        return null;
                    } else {
                        let id = dungeon + (isShadow ? 100 : 0);
                        let dung = DUNGEON_DATA[id];
                        let boss = Object.entries(dung.floors)[enemyIndex];
                        if (boss) {
                            return {
                                id,
                                dungeon: dung,
                                name: boss[0],
                                boss: boss[1]
                            };
                        } else {
                            return null;
                        }
                    }
                }

                function getTwisterEnemyAt (enemyIndex) {
                    if (enemyIndex < 0) {
                        return null;
                    } else {
                        let boss = Object.entries(DUNGEON_DATA['100'].floors).find(x => x[1].pos == enemyIndex);
                        if (boss) {
                            return {
                                id: 100,
                                dungeon: DUNGEON_DATA['100'],
                                name: boss[0],
                                boss: boss[1]
                            }
                        } else {
                            return null;
                        }
                    }
                }

                $('#load-stats').click(() => {
                    toggleAll(true);
                    DatabaseManager.load(SELF_PROFILE).then(function () {
                        $('#stats-list').empty();

                        for (let player of Object.keys(DatabaseManager.Players).map(pid => DatabaseManager.getPlayer(pid).Latest).sort((a, b) => b.Timestamp - a.Timestamp)) {
                            $('#stats-list').append($(`
                                <div class="ui fluid button basic vertical animated gray" style="margin-bottom: 0.5em;">
                                    <div class="visible content">
                                        <span style="color: black;">${ player.Name } @ ${ player.Prefix }<span>
                                    </div>
                                    <div class="hidden content">
                                        <span style="color: black;">Level ${ player.Level } ${ PLAYER_CLASS[player.Class] }<span>
                                    </div>
                                </div>
                                `).click(() => {
                                    dungeon = DUNGEON_DATA[dungeon_current];
                                    boss = boss_current

                                    showData(player.toSimulatorShadowModel());

                                    let normalDungeons = player.Dungeons.Normal.concat(player.Dungeons.Extra.Normal);
                                    let shadowDungeons = player.Dungeons.Shadow.concat(player.Dungeons.Extra.Shadow);
                                    let tower = player.Dungeons.Tower;
                                    let youtube = player.Dungeons.Extra.Youtube;
                                    let twister = player.Dungeons.Twister;

                                    availableBosses = [
                                        ... normalDungeons.map((dungeon, index) => getDungeonEnemyAt(DUNGEON_ARR_TO_DID[index], false, dungeon - 2)),
                                        getDungeonEnemyAt(15, false, player.Dungeons.Normal.Total < 90 ? -1 : tower),
                                        getTwisterEnemyAt(twister - 1),
                                        ... shadowDungeons.map((dungeon, index) => getDungeonEnemyAt(DUNGEON_ARR_TO_DID[index], true, dungeon - 2)),
                                        getDungeonEnemyAt(15, true, youtube - 2),
                                    ].filter(boss => boss);

                                    if (availableBosses.length) {
                                        $('#available-list').parent('.field').removeClass('disabled');
                                        $('#sim-run-all').removeClass('disabled');
                                        $('#available-list').dropdown({
                                            values: availableBosses.map(({ dungeon: _dungeon, boss: _boss, name }, index) => {
                                                return {
                                                    name: `<span${ _dungeon.shadow ? ' style="text-shadow:0px 0px 8px #390074;"' : '' }>
                                                               <img class="ui centered image boss-image" style="position: absolute; right: 0; height: 2.5em; top: 0; width: 2.5em;" src="res/class${ _boss.class }.png">&nbsp;
                                                                   <span class="boss-dungeon-name">${ _dungeon.name }</span>
                                                                   <span class="boss-name">${ _boss.pos }. ${ name }</span>
                                                                   ${ _boss.runes ? `
                                                                       <span class="boss-rune">
                                                                           ${ _boss.runes.damage } ${ ['F', 'C', 'L'][ _boss.runes.type - 40 ] } / ${ (_boss.runes.res || ['?', '?', '?']).map((res, i) => `${ res } ${ [ 'F', 'C', 'L' ][i] }`).join('&nbsp; ') }
                                                                       </span>
                                                                   ` : '' }
                                                           <span>`,
                                                    value: index
                                                };
                                            })
                                        }).dropdown('setting', 'onChange', (value, text) => {
                                            if (!isNaN(value) && value && value.length > 0) {
                                                settingsChanged();

                                                let sel = availableBosses[value];

                                                dungeon = sel.dungeon;
                                                boss = getBossData(sel.boss, sel.name);

                                                withoutUpdate(() => {
                                                    $('#dungeon-list').dropdown('set selected', sel.id);
                                                    $('#boss-list').dropdown('set selected', sel.name);
                                                });
                                            }
                                        });
                                    } else {
                                        $('#available-list').parent('.field').addClass('disabled');
                                        $('#sim-run-all').addClass('disabled');
                                    }
                                }
                            ));
                        }

                        $('#stats-list').append(
                            $('<div class="ui two basic tiny gray buttons"></div>').append(
                                $(`
                                    <div class="ui fluid button vertical">
                                        <div class="visible content">
                                            <span style="color: gray;">Endpoint<span>
                                        </div>
                                    </div>
                                `).click(() => {
                                    Endpoint.start('endpoint/dungeons').then(() => {
                                        $('#load-stats').trigger('click');
                                    });
                                }),
                                $(`
                                    <label class="ui fluid button vertical" for="button-upload">
                                        <span style="color: gray;">HAR<span>
                                    </label>
                                    <input type="file" multiple data-op="upload" accept=".har,.json" class="css-hidden" id="button-upload">
                                `).change((fileEvent) => {
                                    toggleAll(true);

                                    let pendingPromises = [];
                                    Array.from(fileEvent.target.files).forEach(file => {
                                        pendingPromises.push(file.text().then(fileContent => {
                                            return DatabaseManager.import(fileContent, file.lastModified, undefined, 'har/dungeons');
                                        }));
                                    });

                                    Promise.all(pendingPromises).then(() => {
                                        $('#load-stats').trigger('click');
                                    });
                                })
                            )
                        );

                        toggleAll();
                    }).catch(function () {
                        toggleAll();
                        Logger.log('WARNING', 'Database could not be opened!');
                        $('#stats-list').empty();
                    });
                });

                function showMassDungeonResults (bosses, results) {
                    bosses = bosses.map((dungeon, index) => Object.assign(_dig(results, index), dungeon)).sort((b, a) => a.score - b.score);

                    $('#results-modal .content').html(`
                        <div class="ui two column grid">
                            ${ bosses.map(({ boss, dungeon, name, score, healths, iterations }, index) => {
                                return `
                                    <div class="row" data-id="${index}" style="padding: 0;">
                                        <div class="eleven wide column" style="position: relative; padding-top: 1rem; padding-bottom: 1rem;">
                                            <span${ dungeon.shadow ? ' style="text-shadow:0px 0px 8px #390074;"' : '' }>
                                                <img class="ui centered image boss-image" style="position: absolute; left: 0; height: 2.5em; top: 0.5em; width: 2.5em;" src="res/class${ boss.class }.png">&nbsp;
                                                <span style="position: absolute; left: 3.75em; top: 0.4em; font-size: 80%;">${ dungeon.name }</span>
                                                <span style="position: absolute; left: 3em; top: 1.4em;">${ name }</span>
                                            </span>
                                        </div>
                                        <div class="five wide column text-center" style="padding-top: 1rem; padding-bottom: 1rem;">${ score == 0 ? 'Not possible' : `${ (100 * score / iterations).toFixed(2) }%` }</div>
                                    </div>
                                `;
                            }).join('') }
                        </div>
                    `);
                    $('#results-modal .content .row').mouseenter((event) => {
                        let index = event.currentTarget.dataset.id;
                        let { boss, dungeon, name, score, healths, iterations } = bosses[index];
                        showGraph(chartList, dungeon, { Name: name }, score, iterations, healths);
                    });
                    $('#results-modal .content .row').first().trigger('mouseenter');
                    $('#results-modal').modal('show');
                }

                function preparePlayerInstances (dungeon) {
                    let playerInstances = players.map(p => JSON.parse(JSON.stringify(p)));

                    if (dungeon.shadow) {
                        let bert = playerInstances[1];

                        let hp_a = (100 + bert.Dungeons.Player) / 100;
                        let hp_b = (100 + bert.Potions.Life) / 100;
                        let hp_c = (100 + bert.Runes.Health) / 100;
                        let hp_d = 1.22;

                        playerInstances[1].NoSkip = true;
                        playerInstances[1].AutoHealth = Math.trunc(Math.floor(bert.Constitution.Total * 5 * (bert.Level + 1) * hp_a) * hp_b * hp_c * hp_d);
                    }

                    if (playerInstances[0].Class == 1 && playerInstances[0].BlockChance == '0') {
                        playerInstances[0].NoSkip = true;
                    }

                    for (let i = 0; i < 4; i++) {
                        playerInstances[i].IsRealPlayer = true;
                    }

                    return dungeon.shadow ? [ ... playerInstances.slice(1, 4), playerInstances[0] ] : [ playerInstances[0] ];
                }

                $('#sim-run-all').click(function () {
                    if (availableBosses && availableBosses.length > 0 && EditorController.valid()) {
                        toggleAll(true);

                        let results = [];
                        let resultsRemaining = availableBosses.length;

                        let maximumInstances = Math.max(1, Number($('#sim-threads').val()) || LOGICAL_PROCS);
                        let iterations = Math.max(1, Number($('#sim-iterations').val()) || 5000);

                        let pendingInstances = [];

                        for (let [index, { boss, dungeon, name }] of Object.entries(availableBosses)) {
                            let worker = createWebWorker('js/sim/dungeons.js');

                            worker.addEventListener('message', (message) => {
                                if (message.data.command == 'finished') {
                                    let { score, iterations, healths } = message.data.results;

                                    results[message.data.index] = {
                                        score,
                                        healths,
                                        iterations
                                    };

                                    if (--resultsRemaining <= 0) {
                                        toggleAll();
                                        showMassDungeonResults(availableBosses, results);
                                    } else if (pendingInstances.length > 0) {
                                        let [ secWorker, args ] = pendingInstances.pop();
                                        secWorker.postMessage(args);
                                    }
                                }
                            }, false);

                            pendingInstances.push([worker, {
                                players: preparePlayerInstances(dungeon),
                                boss: getBossData(boss),
                                iterations: iterations,
                                index: index,
                                hpcap: 500
                            }])
                        }

                        let currentInstances = Math.min(maximumInstances, pendingInstances.length);
                        for (let i = 0; i < currentInstances; i++) {
                            let [ worker, args ] = pendingInstances.pop();
                            worker.postMessage(args);
                        }
                    }
                });

                $('#sim-run').click(function () {
                    if (boss && EditorController.valid()) {
                        toggleAll(true);

                        let playerInstances = preparePlayerInstances(dungeon);
                        let threads = Math.max(1, Number($('#sim-threads').val()) || 2);
                        let iterations = Math.max(1, Number($('#sim-iterations').val()) || 5000);

                        let results = [];
                        let totalScore = 0;
                        let totalTries = 0;

                        if (log) {
                            threads = 1;
                            iterations = 2000;
                        }

                        for (let i = 0; i < threads; i++) {
                            let worker = createWebWorker('js/sim/dungeons.js');

                            worker.addEventListener('message', (message) => {
                                if (message.data.command == 'finished') {
                                    let { score, iterations, healths } = message.data.results;
                                    if (message.data.log.length) {
                                        download('logs.json', new Blob([ JSON.stringify({
                                            fights: message.data.log,
                                            players: players,
                                            boss: boss
                                        }) ], {
                                            type: 'application/json'
                                        }));
                                    }

                                    results.push(healths)
                                    totalScore += score;
                                    totalTries += iterations;

                                    if (totalTries == threads * iterations) {
                                        let finalResults = new Array(results[0].length);
                                        for (let i = 0; i < results[0].length; i++) {
                                            let healthsSum = 0;
                                            for (let j = 0; j < threads; j++) {
                                                healthsSum += results[j][i];
                                            }

                                            finalResults[i] = healthsSum / threads;
                                        }

                                        showGraph(chart, dungeon, boss, totalScore, totalTries, _sort_asc(finalResults));
                                        $('#winchart').removeClass('faded-out');
                                        toggleAll();
                                    }
                                }
                            }, false);

                            worker.postMessage({
                                players: playerInstances,
                                boss: boss,
                                iterations: iterations,
                                log: log
                            });
                        }
                    }
                });

                function showGraph (graph, dungeon, boss, score, tries, healths) {
                    graph.options.title.text = [
                        `${ dungeon.shadow ? 'Shadow ' : '' }${ dungeon.name }: ${ boss.Name }`,
                        `Winrate: ${ (100 * score / tries).toFixed(2) }% (${ formatAsSpacedNumber(score, ' ') } out of ${ formatAsSpacedNumber(tries, ' ') })`
                    ];
                    graph.data.datasets[0].data = healths.map((h, i) => { return { x: i, y: h * 100 }; });
                    graph.data.labels = healths.map((a, b) => b);
                    graph.update(0);
                }
            });
        </script>
    </body>
</html>
