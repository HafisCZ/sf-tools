<!DOCTYPE html>
<html lang="en">
    <head>
        <title>SFTools - Fight Viewer</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="res/favicon.png"/>

        <link rel="stylesheet" href="vendor/css/semantic.min.css"/>
        <link rel="stylesheet" href="css/style.css"/>

        <script src="vendor/js/jquery.3.4.1.min.js"></script>
        <script src="vendor/js/semantic.min.js"></script>

        <script src="js/enum.js"></script>
        <script src="js/util.js"></script>
        <script src="js/lang.js"></script>

        <script src="js/core/util.js"></script>
        <script src="js/core/playa.js"></script>
        <script src="js/core/core.js"></script>
        <script src="js/changelog.js"></script>
        <script src="js/views.js"></script>

        <link href="https://fonts.googleapis.com/css?family=Roboto:300&display=swap" rel="stylesheet">

        <style>
            #fi-select {
                margin-right: 10em;
                width: 18em;
            }

            #fi-select .item {
                padding: 0 !important;
            }

            #fi-select {
                padding: 0 !important;
            }

            .fi-wrap {
                position: relative;
                height: 2em;
                margin-top: 0.4em;
            }

            .menu.transition .fi-wrap {
                height: 2.5em;
            }

            .item.active.selected {
                font-weight: 300;
            }

            .fi-wrap br {
                height: 0.25em;
            }

            .fi-right {
                position: absolute;
                left: 3em;
                width: 20em;
            }

            .fi-left {
                position: absolute;
                left: 0.75em;
            }

            [data-op="Name"] {
                font-size: 1.25em !important;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="ui fixed borderless huge menu css-menu">
            <div class="header item"><a class="css-a-blank" href="index.html">SFTools</a></div>
            <label for="fi-open">
                <a class="item"><i class="small upload icon"></i>Open</a>
            </label>
            <input type="file" id="fi-open" accept=".har,.json" multiple hidden>
            <a class="item" id="fi-clear"><i class="small trash alternate outline icon"></i>Clear</a>
            <a class="item" id="fi-saveall"><i class="small download icon"></i>Export All</a>
            <a class="item" id="fi-copyall"><i class="small copy outline icon"></i>Copy All</a>
            <a class="item" id="fi-save"><i class="small download icon"></i>Export Current</a>
            <a class="item" id="fi-copy"><i class="small copy outline icon"></i>Copy Current</a>
            <div class="right menu">
                <div class="ui selection compact dropdown" id="fi-select">
                    <div class="text"></div>
                    <i class="dropdown icon"></i>
                </div>
            </div>
        </div>
        <div class="ui main container">
            <div class="ui basic segment" id="fi-content">
                <div class="ui small form">
                    <div class="ui grid">
                        <div class="two columns row">
                            <div class="column" id="fi-fighterA">
                                <div class="field">
                                    <div class="ui icon input">
                                        <input type="text" disabled class="text-center" data-op="Name">
                                        <i class="copy outline link icon" data-op="copy"></i>
                                    </div>
                                </div>
                                <div class="two fields">
                                    <div class="field">
                                        <label>Class</label>
                                        <input type="text" disabled class="text-center" data-op="Class">
                                    </div>
                                    <div class="field">
                                        <label>Level</label>
                                        <input type="text" disabled class="text-center" data-op="Level">
                                    </div>
                                </div>
                                <div class="two fields">
                                    <div class="field">
                                        <label>Minimum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Min1">
                                    </div>
                                    <div class="field">
                                        <label>Maximum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Max1">
                                    </div>
                                    <div class="field">
                                        <label>Element type</label>
                                        <input type="text" disabled class="text-center" data-op="Type1">
                                    </div>
                                    <div class="field">
                                        <label>Element value</label>
                                        <input type="text" disabled class="text-center" data-op="Value1">
                                    </div>
                                </div>
                                <div class="two fields" data-op="Weapon2">
                                    <div class="field">
                                        <label>Minimum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Min2">
                                    </div>
                                    <div class="field">
                                        <label>Maximum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Max2">
                                    </div>
                                    <div class="field">
                                        <label>Element type</label>
                                        <input type="text" disabled class="text-center" data-op="Type2">
                                    </div>
                                    <div class="field">
                                        <label>Element value</label>
                                        <input type="text" disabled class="text-center" data-op="Value2">
                                    </div>
                                </div>
                                <div class="five fields">
                                    <div class="field">
                                        <label>Strength</label>
                                        <input type="text" disabled class="text-center" data-op="Strength">
                                    </div>
                                    <div class="field">
                                        <label>Dexterity</label>
                                        <input type="text" disabled class="text-center" data-op="Dexterity">
                                    </div>
                                    <div class="field">
                                        <label>Intelligence</label>
                                        <input type="text" disabled class="text-center" data-op="Intelligence">
                                    </div>
                                    <div class="field">
                                        <label>Constitution</label>
                                        <input type="text" disabled class="text-center" data-op="Constitution">
                                    </div>
                                    <div class="field">
                                        <label>Luck</label>
                                        <input type="text" disabled class="text-center" data-op="Luck">
                                    </div>
                                </div>
                                <div class="three fields">
                                    <div class="field">
                                        <label>Armor</label>
                                        <input type="text" class="text-center" data-op="Armor">
                                    </div>
                                    <div class="field">
                                        <label>Health</label>
                                        <input type="text" disabled class="text-center" data-op="Health">
                                    </div>
                                    <div class="field">
                                        <label>Current Health</label>
                                        <input type="text" disabled class="text-center" data-op="CurrentHealth">
                                    </div>
                                </div>
                                <div class="three fields">
                                    <div class="field">
                                        <label>Total Hits</label>
                                        <input type="text" disabled class="text-center" data-op="Hits">
                                    </div>
                                    <div class="field">
                                        <label>Critical Hits</label>
                                        <input type="text" disabled class="text-center" data-op="Crits">
                                    </div>
                                    <div class="field" data-op="BlocksField">
                                        <label>Hits Blocked/Evaded</label>
                                        <input type="text" disabled class="text-center" data-op="Skips">
                                    </div>
                                    <div class="field" data-op="RevivesField">
                                        <label>Revives</label>
                                        <input type="text" disabled class="text-center" data-op="Revives">
                                    </div>
                                    <div class="field" data-op="SpellsField">
                                        <label>Spells</label>
                                        <input type="text" disabled class="text-center" data-op="Spells">
                                    </div>
                                </div>
                            </div>
                            <div class="column" id="fi-fighterB">
                                <div class="field">
                                    <div class="ui icon input">
                                        <input type="text" disabled class="text-center" data-op="Name">
                                        <i class="copy outline link icon" data-op="copy"></i>
                                    </div>
                                </div>
                                <div class="two fields">
                                    <div class="field">
                                        <label>Class</label>
                                        <input type="text" disabled class="text-center" data-op="Class">
                                    </div>
                                    <div class="field">
                                        <label>Level</label>
                                        <input type="text" disabled class="text-center" data-op="Level">
                                    </div>
                                </div>
                                <div class="two fields">
                                    <div class="field">
                                        <label>Minimum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Min1">
                                    </div>
                                    <div class="field">
                                        <label>Maximum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Max1">
                                    </div>
                                    <div class="field">
                                        <label>Element type</label>
                                        <input type="text" disabled class="text-center" data-op="Type1">
                                    </div>
                                    <div class="field">
                                        <label>Element value</label>
                                        <input type="text" disabled class="text-center" data-op="Value1">
                                    </div>
                                </div>
                                <div class="two fields" data-op="Weapon2">
                                    <div class="field">
                                        <label>Minimum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Min2">
                                    </div>
                                    <div class="field">
                                        <label>Maximum damage</label>
                                        <input type="text" disabled class="text-center" data-op="Max2">
                                    </div>
                                    <div class="field">
                                        <label>Element type</label>
                                        <input type="text" disabled class="text-center" data-op="Type2">
                                    </div>
                                    <div class="field">
                                        <label>Element value</label>
                                        <input type="text" disabled class="text-center" data-op="Value2">
                                    </div>
                                </div>
                                <div class="five fields">
                                    <div class="field">
                                        <label>Strength</label>
                                        <input type="text" disabled class="text-center" data-op="Strength">
                                    </div>
                                    <div class="field">
                                        <label>Dexterity</label>
                                        <input type="text" disabled class="text-center" data-op="Dexterity">
                                    </div>
                                    <div class="field">
                                        <label>Intelligence</label>
                                        <input type="text" disabled class="text-center" data-op="Intelligence">
                                    </div>
                                    <div class="field">
                                        <label>Constitution</label>
                                        <input type="text" disabled class="text-center" data-op="Constitution">
                                    </div>
                                    <div class="field">
                                        <label>Luck</label>
                                        <input type="text" disabled class="text-center" data-op="Luck">
                                    </div>
                                </div>
                                <div class="three fields">
                                    <div class="field">
                                        <label>Armor</label>
                                        <input type="text" class="text-center" data-op="Armor">
                                    </div>
                                    <div class="field">
                                        <label>Health</label>
                                        <input type="text" disabled class="text-center" data-op="Health">
                                    </div>
                                    <div class="field">
                                        <label>Current Health</label>
                                        <input type="text" disabled class="text-center" data-op="CurrentHealth">
                                    </div>
                                </div>
                                <div class="three fields">
                                    <div class="field">
                                        <label>Total Hits</label>
                                        <input type="text" disabled class="text-center" data-op="Hits">
                                    </div>
                                    <div class="field">
                                        <label>Critical Hits</label>
                                        <input type="text" disabled class="text-center" data-op="Crits">
                                    </div>
                                    <div class="field" data-op="BlocksField">
                                        <label>Hits Blocked/Evaded</label>
                                        <input type="text" disabled class="text-center" data-op="Skips">
                                    </div>
                                    <div class="field" data-op="RevivesField">
                                        <label>Revives</label>
                                        <input type="text" disabled class="text-center" data-op="Revives">
                                    </div>
                                    <div class="field" data-op="SpellsField">
                                        <label>Spells</label>
                                        <input type="text" disabled class="text-center" data-op="Spells">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="fi-rounds">
                            <!-- ROUNDS HERE -->
                        </div>
                    </div>
                </div>
                <div class="ui close right rail">
                    <div class="ui basic segment">
                        <h2 class="ui centered header">Damage Analysis</h2>
                        <div class="ui mini form">
                            <h4 class="ui header" id="dmg-name1">Player A</h4>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Enchantment</label>
                                    <div class="ui selection compact dropdown" id="dmg-enchant1">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="text-center">Gladiator</label>
                                    <div class="ui selection compact dropdown" id="dmg-gladiator1">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min</label>
                                    <input type="text" disabled class="text-center" id="dmg-min1">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max</label>
                                    <input type="text" disabled class="text-center" id="dmg-max1">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg-mincrit1">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg-maxcrit1">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min 2</label>
                                    <input type="text" disabled class="text-center" id="dmg2-min1">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max 2</label>
                                    <input type="text" disabled class="text-center" id="dmg2-max1">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min 2 (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg2-mincrit1">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max 2 (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg2-maxcrit1">
                                </div>
                            </div>
                            <h4 class="ui header" id="dmg-name2">Player B</h4>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Enchantment</label>
                                    <div class="ui selection compact dropdown" id="dmg-enchant2">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="text-center">Gladiator</label>
                                    <div class="ui selection compact dropdown" id="dmg-gladiator2">
                                        <div class="text"></div>
                                        <i class="dropdown icon"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min</label>
                                    <input type="text" disabled class="text-center" id="dmg-min2">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max</label>
                                    <input type="text" disabled class="text-center" id="dmg-max2">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg-mincrit2">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg-maxcrit2">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min 2</label>
                                    <input type="text" disabled class="text-center" id="dmg2-min2">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max 2</label>
                                    <input type="text" disabled class="text-center" id="dmg2-max2">
                                </div>
                            </div>
                            <div class="two fields">
                                <div class="field">
                                    <label class="text-center">Min 2 (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg2-mincrit2">
                                </div>
                                <div class="field">
                                    <label class="text-center">Max 2 (from Crits)</label>
                                    <input type="text" disabled class="text-center" id="dmg2-maxcrit2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            // Conversion & Export function
            function exportFightData (fights) {
                download(fights.length == 1 ? `${ fights[0].fighterA.Name }/${ fights[0].fighterB.Name }.json` : 'fights.json', new Blob([
                    JSON.stringify(fights.map(fight => {
                        return {
                            targetA: fight.fighterA,
                            targetB: fight.fighterB,
                            rounds: fight.rounds.map(round => {
                                return {
                                    attackCrit: round.attackCrit,
                                    attackType: round.attackType,
                                    attackMissed: round.attackMissed,
                                    attackDamage: round.attackDamage,
                                    attackSecondary: round.attackSecondary,
                                    attacker: round.attacker.ID,
                                    target: round.target.ID
                                };
                            })
                        };
                    }))
                ], {
                    type: 'application/json'
                }));
            }

            function copyFightData (fights) {
                var content = [];

               for (var tab of fights) {
                   var rows = [];

                   Object.entries(tab.fighterA).forEach(([key, val]) => {
                       if (val instanceof SFItem || val.DamageMin != undefined) {
                           rows.push([ key ]);
                           rows.push([ '', 'MinDmg', val.DamageMin ]);
                           rows.push([ '', 'MaxDmg', val.DamageMax ]);
                       } else if (key == 'Face') {
                           rows.push([ key, val.Mouth ]);
                       } else {
                           rows.push([ key, val ]);
                       }
                   });

                   Object.entries(tab.fighterB).forEach(([key, val]) => {
                       if (val instanceof SFItem || val.DamageMin != undefined) {
                           rows.push([ key ]);
                           rows.push([ '', 'MinDmg', val.DamageMin ]);
                           rows.push([ '', 'MaxDmg', val.DamageMax ]);
                       } else if (key == 'Face') {
                           rows.push([ key, val.Mouth ]);
                       } else {
                           rows.push([ key, val ]);
                       }
                   });

                   rows.push([ 'index', 'attacker', 'target', 'type', 'damage' ]);
                   tab.rounds.forEach((round, i) => {
                       rows.push([ i, round.attacker.ID, round.target.ID, ATTACK_TYPES[round.attackType], round.attackDamage ]);
                   });

                   content.push(rows);
               }

               var maxColumns = Math.max(... content[0].map(r => r.length));
               var maxRows = Math.max(... content.map(r => r.length));

               var rows = [];
               for (var c of content) {
                   for (var i = 0; i < maxRows; i++) {
                       var x = [];
                       if (c[i]) {
                           x.push(... c[i].map(y => `<td>${ y }</td>`));
                       }
                       while (x.length < maxColumns) {
                           x.push(`<td></td>`);
                       }
                       if (rows[i]) {
                           rows[i].push(...x);
                       } else {
                           rows[i] = x;
                       }
                   }
               }

               // Create element
               var el = document.createElement('table');
               el.innerHTML = `<tbody>${ rows.map(r => `<tr>${ r.join('') }</tr>`).join('') }</tbody>`;
               document.body.appendChild(el);

               // Create range, select element and copy
               var range = document.createRange();
               range.selectNode(el);
               window.getSelection().removeAllRanges();
               window.getSelection().addRange(range);
               document.execCommand('copy');
               window.getSelection().removeAllRanges();

               // Destroy element
               document.body.removeChild(el);
            }

            // File export
            var $fileSave = $('#fi-save').on('click', function () {
                if (fightData.length && fightIndex >= 0) {
                    exportFightData([ fightData[fightIndex] ]);
                }
            });

            var $fileSaveBulk = $('#fi-saveall').on('click', function () {
                if (fightData.length) {
                    exportFightData(fightData);
                }
            });

            var $fileCopy = $('#fi-copy').on('click', function () {
                if (fightData.length && fightIndex >= 0) {
                    copyFightData([ fightData[fightIndex] ]);
                }
            });

            var $fileCopyBulk = $('#fi-copyall').on('click', function () {
                if (fightData.length) {
                    copyFightData(fightData);
                }
            });

            var $fileClear = $('#fi-clear').on('click', function () {
                fightData = [];
                updateSelector();
            });

            // File selector
            var $fileSelect = $('#fi-select').dropdown({
                preserveHTML: true,
                values: []
            }).dropdown('setting', 'onChange', (value, text) => {
                fightIndex = Number(value);
                updateFight();
            }).hide();

            // File open
            var $fileOpen = $('#fi-open').on('change', function () {
                Array.from(this.files).forEach(file => {
                    var r = new FileReader();
                    r.readAsText(file, 'UTF-8');
                    r.onload = event => {
                        try {
                            var data = JSON.parse(event.target.result);

                            if (data.fights) {
                                importJSON(data.fights);
                            } else if (data.rounds) {
                                importJSON([ data ]);
                            } else if (Array.isArray(data)) {
                                importJSON(data);
                            } else {
                                importHAR(data);
                            }

                            updateSelector();
                        } catch (exception) {
                            console.warn(exception);
                        }
                    };
                });
            });

            // Damage calculations
            var glad1 = 0;
            var glad2 = 0;
            var enchant1 = 0;
            var enchant2 = 0;

            $('#dmg-gladiator1').dropdown({
                values: [
                    { name: 'None', value: 0 },
                    ... [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ].map(gladiator => {
                        return {
                            name: `${ gladiator } (${ gladiator * 5 }%)`,
                            value: gladiator
                        }
                    })
                ]
            }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                glad1 = Number(value);
                updateDamage();
            });

            $('#dmg-gladiator2').dropdown({
                values: [
                    { name: 'None', value: 0 },
                    ... [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ].map(gladiator => {
                        return {
                            name: `${ gladiator } (${ gladiator * 5 }%)`,
                            value: gladiator
                        }
                    })
                ]
            }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                glad2 = Number(value);
                updateDamage();
            });

            $('#dmg-enchant1').dropdown({
                values: [
                    { name: 'No', value: 0 },
                    { name: 'Yes', value: 1 }
                ]
            }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                enchant1 = Number(value);
                updateDamage();
            });

            $('#dmg-enchant2').dropdown({
                values: [
                    { name: 'No', value: 0 },
                    { name: 'Yes', value: 1 }
                ]
            }).dropdown('set selected', '0').dropdown('setting', 'onChange', (value, text) => {
                enchant2 = Number(value);
                updateDamage();
            });

            // Current data
            var fightIndex = -1;
            var fightData = [];
            var damageData = {};

            var $content = $('#fi-content').hide();
            var $fighterA = $('#fi-fighterA');
            var $fighterB = $('#fi-fighterB');
            var $rounds = $('#fi-rounds');

            // Update functions
            function updateSelector () {
                $fileSelect.dropdown('setup menu', {
                    values: fightData.map((fight, index) => {
                        return {
                            name: `
                                <div class="fi-wrap">
                                    <div class="fi-left">${ index + 1 }.</div>
                                    <div class="fi-right">
                                        <span class="${ fight.winner.ID != fight.fighterA.ID ? 'foreground-red' : 'foreground-green' }">${ fight.fighterA.Name }</span>
                                        </br>
                                        <span class="${ fight.winner.ID != fight.fighterB.ID ? 'foreground-red' : 'foreground-green' }">${ fight.fighterB.Name }</span>
                                    </div>
                                </div>
                            `,
                            value: index.toString()
                        };
                    })
                });

                damageData = getDamages();
                fightIndex = fightData.length ? 0 : -1;

                if (fightIndex >= 0) {
                    $fileSelect.show().dropdown('set selected', '0');
                } else {
                    $fileSelect.hide();
                    updateFight();
                }
            }

            function getAttributeForClass (p, c) {
                switch (c) {
                    case 1:
                    case 5:
                    case 6:
                        return p.Strength;
                    case 2:
                    case 8:
                        return p.Intelligence;
                    default:
                        return p.Dexterity;
                }
            }

            function getTargetResistance (p, t, tarmor) {
                if (p.Class == 2) {
                    return 0;
                } else if (t.Class == 8) {
                    return Math.min([ 10, 50, 25 ][ t.Mask ], tarmor / p.Level);
                } else {
                    return Math.min([ 50, 10, 25, 25, 50, 25, 50 ][ t.Class - 1 ], tarmor / p.Level + (t.Class == 5 ? 40 : 0));
                }
            }

            function getHPMultiplier (c, mask) {
                switch (c) {
                    case 1:
                    case 5:
                        return 5;
                    case 7:
                    case 3:
                    case 4:
                    case 6:
                        return 4;
                    case 2:
                        return 2;
                    case 8:
                        return mask == 1 ? 5 : (mask == 2 ? 4 : 2);
                    default:
                        return 0;
                }
            }

            function fillFighter ($parent, f, winner, o, tarmor = 0) {
                var $name = $parent.find('[data-op="Name"]').val(f.Name);
                if (winner) {
                    $name.addClass('foreground-green').removeClass('foreground-red');
                } else {
                    $name.addClass('foreground-red').removeClass('foreground-green');
                }

                var id = getID(f, o);
                var id2 = id + '_2';

                $parent.find('[data-op="Level"]').val(f.Level);
                $parent.find('[data-op="Class"]').val(
                    `${PLAYER_CLASS[f.Class]}${f.Class == 8 ? [ '', ' - Bear', ' - Cat' ][ f.Mask ] : ''}${f.Class == 9 ? ` - ${INSTRUMENT_TYPES[ f.Instrument ]}` : ''}`
                );

                var skillMain = getAttributeForClass(f, f.Class);
                var skillTarget = getAttributeForClass(o, f.Class);
                var skillmult = 1 + Math.max(skillMain / 2, skillMain - skillTarget / 2) / 10;
                var armormult = 1 - getTargetResistance(f, o, tarmor) / 100;

                if (f.Wpn1.DamageMin) {
                    $parent.find('[data-op="Min1"]').val(formatAsSpacedNumber(f.Wpn1.DamageMin, ' '));
                    $parent.find('[data-op="Max1"]').val(formatAsSpacedNumber(f.Wpn1.DamageMax, ' '));
                } else if (damageData[id] && damageData[id].normal) {
                    var approxMin = damageData[id].normal.min / skillmult / armormult;
                    var approxMax = damageData[id].normal.max / skillmult / armormult;

                    $parent.find('[data-op="Min1"]').val(`~ ${ formatAsSpacedNumber(approxMin, ' ') }`);
                    $parent.find('[data-op="Max1"]').val(`~ ${ formatAsSpacedNumber(approxMax, ' ') }`);

                    f.Wpn1ApproxMin = Math.trunc(approxMin);
                    f.Wpn1ApproxMax = Math.trunc(approxMax);
                } else {
                    $parent.find('[data-op="Min1"]').val('');
                    $parent.find('[data-op="Max1"]').val('');
                }

                if (f.Wpn1.AttributeTypes[2] >= 30) {
                    $parent.find('[data-op="Type1"]').val(RUNETYPES[f.Wpn1.AttributeTypes[2] - 30].split(' ')[0]).parent('div').show();
                    $parent.find('[data-op="Value1"]').val(f.Wpn1.Attributes[2]).parent('div').show();
                } else {
                    $parent.find('[data-op="Type1"]').parent('div').hide();
                    $parent.find('[data-op="Value1"]').parent('div').hide();
                }

                if (f.Class == 4) {
                    $parent.find('[data-op="Weapon2"]').show();

                    if (f.Wpn2.DamageMin) {
                        $parent.find('[data-op="Min2"]').val(formatAsSpacedNumber(f.Wpn2.DamageMin, ' '));
                        $parent.find('[data-op="Max2"]').val(formatAsSpacedNumber(f.Wpn2.DamageMax, ' '));
                    } else if (damageData[id2] && damageData[id2].normal) {
                        var approxMin = damageData[id2].normal.min / skillmult / armormult;
                        var approxMax = damageData[id2].normal.max / skillmult / armormult;

                        $parent.find('[data-op="Min2"]').val(`~ ${ formatAsSpacedNumber(approxMin, ' ') }`);
                        $parent.find('[data-op="Max2"]').val(`~ ${ formatAsSpacedNumber(approxMax, ' ') }`);

                        f.Wpn2ApproxMin = Math.trunc(approxMin);
                        f.Wpn2ApproxMax = Math.trunc(approxMax);
                    } else {
                        $parent.find('[data-op="Min2"]').val('');
                        $parent.find('[data-op="Max2"]').val('');
                    }

                    if (f.Wpn2.AttributeTypes[2] >= 30) {
                        $parent.find('[data-op="Type2"]').val(RUNETYPES[f.Wpn2.AttributeTypes[2] - 30].split(' ')[0]).parent('div').show();
                        $parent.find('[data-op="Value2"]').val(f.Wpn2.Attributes[2]).parent('div').show();
                    } else {
                        $parent.find('[data-op="Type2"]').parent('div').hide();
                        $parent.find('[data-op="Value2"]').parent('div').hide();
                    }
                } else {
                    $parent.find('[data-op="Weapon2"]').hide();
                }

                $parent.find('[data-op="Strength"]').val(formatAsSpacedNumber(f.Strength, ' '));
                $parent.find('[data-op="Dexterity"]').val(formatAsSpacedNumber(f.Dexterity, ' '));
                $parent.find('[data-op="Intelligence"]').val(formatAsSpacedNumber(f.Intelligence, ' '));
                $parent.find('[data-op="Constitution"]').val(formatAsSpacedNumber(f.Constitution, ' '));
                $parent.find('[data-op="Luck"]').val(formatAsSpacedNumber(f.Luck, ' '));
                $parent.find('[data-op="Health"]').val(formatAsSpacedNumber(f.MaximumLife, ' '));

                if (f.MaximumLife != f.Life) {
                    $parent.find('[data-op="CurrentHealth"]').val(formatAsSpacedNumber(f.Life, ' ')).parent('div').show();
                } else {
                    $parent.find('[data-op="CurrentHealth"]').parent('div').hide();
                }

                if ([1, 3, 4, 8].includes(f.Class)) {
                    $parent.find('[data-op="BlocksField"]').show();
                } else {
                    $parent.find('[data-op="BlocksField"]').hide();
                }

                if (f.Class == 7) {
                    $parent.find('[data-op="RevivesField"]').show();
                } else {
                    $parent.find('[data-op="RevivesField"]').hide();
                }

                if (f.Class == 9) {
                    $parent.find('[data-op="SpellsField"]').show();
                } else {
                    $parent.find('[data-op="SpellsField"]').hide();
                }

                $parent.find('[data-op="Hits"]').val(f.Stats.Hits);
                $parent.find('[data-op="Crits"]').val(f.Stats.Crits);
                $parent.find('[data-op="Skips"]').val(f.Stats.Skips);
                $parent.find('[data-op="Revives"]').val(f.Stats.Revives);
                $parent.find('[data-op="Spells"]').val(f.Stats.Spells);

                $parent.find('[data-op="copy"]').off('click').on('click', () => {
                    let multipliers = reverseHealthMultipliers(f.Level, getHPMultiplier(f.Class, f.Mask), f.Constitution, f.MaximumLife);
                    copyText(JSON.stringify({
                        Armor: Number($parent.find('[data-op="Armor"]').val()),
                        Class: f.Class,
                        Mask: f.Mask,
                        Instrument: f.Instrument,
                        Name: f.Name,
                        Level: f.Level,
                        Identifier: f.Identifier,
                        Constitution: {
                            Total: f.Constitution
                        },
                        Dexterity: {
                            Total: f.Dexterity
                        },
                        Dungeons: {
                            Player: multipliers.portal,
                            Group: 0
                        },
                        Fortress: {
                            Gladiator: 0
                        },
                        Underworld: {
                            Gladiator: 0
                        },
                        Intelligence: {
                            Total: f.Intelligence
                        },
                        Strength: {
                            Total: f.Strength
                        },
                        Potions: {
                            Life: multipliers.potion
                        },
                        Luck: {
                            Total: f.Luck
                        },
                        Runes: {
                            Health: multipliers.runes,
                            ResistanceCold: 0,
                            ResistanceFire: 0,
                            ResistanceLightning: 0
                        },
                        Items: {
                            Hand: {
                                HasEnchantment: 0
                            },
                            Wpn1: {
                                AttributeTypes: {
                                    2: f.Wpn1.AttributeTypes[2]
                                },
                                Attributes: {
                                    2: f.Wpn1.Attributes[2]
                                },
                                DamageMax: f.Wpn1.DamageMax || f.Wpn1ApproxMax,
                                DamageMin: f.Wpn1.DamageMin || f.Wpn1ApproxMin,
                                HasEnchantment: f.Wpn1.HasEnchantment
                            },
                            Wpn2: {
                                AttributeTypes: {
                                    2: f.Wpn2.AttributeTypes[2]
                                },
                                Attributes: {
                                    2: f.Wpn2.Attributes[2]
                                },
                                DamageMax: f.Wpn2.DamageMax || f.Wpn2ApproxMax,
                                DamageMin: f.Wpn2.DamageMin || f.Wpn2ApproxMin,
                                HasEnchantment: f.Wpn2.HasEnchantment
                            }
                        }
                    }));
                });
            }

            function updateFight () {
                if (fightIndex >= 0) {
                    var fight = fightData[fightIndex];

                    // Hit statistics
                    fight.fighterA.Stats = { Hits: 0, Crits: 0, Skips: 0, Revives: 0, Spells: 0 };
                    fight.fighterB.Stats = { Hits: 0, Crits: 0, Skips: 0, Revives: 0, Spells: 0 };

                    for (var r of fight.rounds) {
                        if (r.attackType == 15 || r.attackType == 16) {
                            continue;
                        } else if (r.attackType == 100) {
                            r.target.Stats.Revives++;
                        } else if (r.attackType > 100) {
                            r.attacker.Stats.Spells++;
                        } else {
                            if (r.attackMissed) {
                                r.target.Stats.Skips++;
                            } else {
                                r.attacker.Stats.Hits++;

                                if (r.attackCrit) {
                                    r.attacker.Stats.Crits++;
                                }
                            }
                        }
                    }

                    fillFighter($fighterA, fight.fighterA, fight.winner.ID == fight.fighterA.ID, fight.fighterB);
                    fillFighter($fighterB, fight.fighterB, fight.winner.ID == fight.fighterB.ID, fight.fighterA);

                    $rounds.html(fight.rounds.map((round, i) => `
                        <div class="sixteen wide column">
                            <div class="ui basic segment ${ i % 2 ? 'undertone' : '' }">
                                <div class="ui grid">
                                    <div class="one wide column"></div>
                                    <div class="one wide column">${ i + 1 }</div>
                                    <div class="three wide column text-right"><b>${ round.attacker.Name }</b></div>
                                    <div class="one wide column text-center">></div>
                                    <div class="three wide column"><b>${ round.target.Name }</b></div>
                                    <div class="one wide column"></div>
                                    <div class="two wide column text-center ${ round.attackCrit ? 'foreground-red' : '' } ${ round.attackType >= 100 ? 'text-purple' : '' }">${ ATTACK_TYPES[round.attackType] || round.attackType }</div>
                                    <div class="three wide column text-right ${ round.attackCrit ? 'foreground-red text-bold' : '' }">${ round.attackDamage ? formatAsSpacedNumber(round.attackDamage, ' ') : '' }</div>
                                    <div class="one wide column"></div>
                                </div>
                            </div>
                        </div>
                    `).join(''));

                    $fighterA.find('[data-op="Armor"]').val(0).off('input').on('input', () => {
                        var n = $fighterA.find('[data-op="Armor"]').val();
                        if (!isNaN(n)) {
                            fillFighter($fighterB, fight.fighterB, fight.winner.ID == fight.fighterB.ID, fight.fighterA, Number(n));
                        }
                    });

                    if (fight.fighterB.Wpn1.DamageMin == 0) {
                        $fighterA.find('[data-op="Armor"]').parent('.field').removeClass('disabled');
                    } else {
                        $fighterA.find('[data-op="Armor"]').parent('.field').addClass('disabled');
                    }

                    $fighterB.find('[data-op="Armor"]').val(0).off('input').on('input', () => {
                        var n = $fighterB.find('[data-op="Armor"]').val();
                        if (!isNaN(n)) {
                            fillFighter($fighterA, fight.fighterA, fight.winner.ID == fight.fighterA.ID, fight.fighterB, Number(n));
                        }
                    });

                    if (fight.fighterA.Wpn1.DamageMin == 0) {
                        $fighterB.find('[data-op="Armor"]').parent('.field').removeClass('disabled');
                    } else {
                        $fighterB.find('[data-op="Armor"]').parent('.field').addClass('disabled');
                    }

                    $('#dmg-gladiator1').dropdown('set selected', '0');
                    $('#dmg-gladiator2').dropdown('set selected', '0');
                    $('#dmg-enchant1').dropdown('set selected', '0');
                    $('#dmg-enchant2').dropdown('set selected', '0');

                    $content.show();
                } else {
                    $content.hide();
                }
            }

            function updateDamage () {
                var fight = fightData[fightIndex];

                var idA = getID(fight.fighterA, fight.fighterB);
                var idA2 = idA + '_2';
                var idB = getID(fight.fighterB, fight.fighterA);
                var idB2 = idB + '_2';

                var ca = 2 * (1 + 0.05 * enchant1) * (1 + 0.05 * glad1);
                var cb = 2 * (1 + 0.05 * enchant2) * (1 + 0.05 * glad2);

                $('#dmg-name1').text(fight.fighterA.Name);
                $('#dmg-name2').text(fight.fighterB.Name);

                if (damageData[idA] && damageData[idA].normal) {
                    $('#dmg-min1').closest('.fields').show();
                    $('#dmg-min1').val(formatAsSpacedNumber(damageData[idA].normal.min, ' '));
                    $('#dmg-max1').val(formatAsSpacedNumber(damageData[idA].normal.max, ' '));
                } else {
                    $('#dmg-min1').closest('.fields').hide();
                }

                if (damageData[idA2] && damageData[idA2].normal) {
                    $('#dmg2-min1').closest('.fields').show();
                    $('#dmg2-min1').val(formatAsSpacedNumber(damageData[idA2].normal.min, ' '));
                    $('#dmg2-max1').val(formatAsSpacedNumber(damageData[idA2].normal.max, ' '));
                } else {
                    $('#dmg2-min1').closest('.fields').hide();
                }

                if (damageData[idB] && damageData[idB].normal) {
                    $('#dmg-min2').closest('.fields').show();
                    $('#dmg-min2').val(formatAsSpacedNumber(damageData[idB].normal.min, ' '));
                    $('#dmg-max2').val(formatAsSpacedNumber(damageData[idB].normal.max, ' '));
                } else {
                    $('#dmg-min2').closest('.fields').hide();
                }

                if (damageData[idB2] && damageData[idB2].normal) {
                    $('#dmg2-min2').closest('.fields').show();
                    $('#dmg2-min2').val(formatAsSpacedNumber(damageData[idB2].normal.min, ' '));
                    $('#dmg2-max2').val(formatAsSpacedNumber(damageData[idB2].normal.max, ' '));
                } else {
                    $('#dmg2-min2').closest('.fields').hide();
                }

                if (damageData[idA] && damageData[idA].crit) {
                    $('#dmg-mincrit1').closest('.fields').show();
                    $('#dmg-mincrit1').val(formatAsSpacedNumber(damageData[idA].crit.min / ca, ' '));
                    $('#dmg-maxcrit1').val(formatAsSpacedNumber(damageData[idA].crit.max / ca, ' '));
                } else {
                    $('#dmg-mincrit1').closest('.fields').hide();
                }

                if (damageData[idA2] && damageData[idA2].crit) {
                    $('#dmg2-mincrit1').closest('.fields').show();
                    $('#dmg2-mincrit1').val(formatAsSpacedNumber(damageData[idA2].crit.min / ca, ' '));
                    $('#dmg2-maxcrit1').val(formatAsSpacedNumber(damageData[idA2].crit.max / ca, ' '));
                } else {
                    $('#dmg2-mincrit1').closest('.fields').hide();
                }

                if (damageData[idB] && damageData[idB].crit) {
                    $('#dmg-mincrit2').closest('.fields').show();
                    $('#dmg-mincrit2').val(formatAsSpacedNumber(damageData[idB].crit.min / cb, ' '));
                    $('#dmg-maxcrit2').val(formatAsSpacedNumber(damageData[idB].crit.max / cb, ' '));
                } else {
                    $('#dmg-mincrit2').closest('.fields').hide();
                }

                if (damageData[idB2] && damageData[idB2].crit) {
                    $('#dmg2-mincrit2').closest('.fields').show();
                    $('#dmg2-mincrit2').val(formatAsSpacedNumber(damageData[idB2].crit.min / cb, ' '));
                    $('#dmg2-maxcrit2').val(formatAsSpacedNumber(damageData[idB2].crit.max / cb, ' '));
                } else {
                    $('#dmg2-mincrit2').closest('.fields').hide();
                }
            }

            function importJSON (json) {
                fightData.push(... json.map(f => {
                    return {
                        fighterA: f.targetA,
                        fighterB: f.targetB,
                        winner: f.rounds[f.rounds.length - 1].target == f.targetA.ID ? f.targetB : f.targetA,
                        rounds: f.rounds.map(r => {
                            return {
                                attackCrit: r.attackCrit,
                                attackType: r.attackType,
                                attackMissed: r.attackMissed,
                                attackDamage: r.attackDamage,
                                attackSecondary: r.attackSecondary,
                                attacker: r.attacker == f.targetA.ID ? f.targetA : f.targetB,
                                target: r.target == f.targetA.ID ? f.targetA : f.targetB
                            };
                        })
                    };
                }));
            }

            function findFightsInJSON (json) {
                let fights = [];
                for (let [k, v] of filterPlayaJSON(json)) {
                    if (k == 'text' && v.includes('fightheader')) {
                        let cr = [];
                        for (let [kb, vb] of parsePlayaResponse(v)) {
                            if (kb.includes('.fighters')) {
                                cr.push(['fighters', vb].join(':'));
                            } else if (kb.includes('.r')) {
                                cr.push(['r', vb].join(':'));
                            } else if (kb.includes('winnerid')) {
                                cr.push(['winnerid', vb].join(':'));
                                fights.push(cr.join('&'));
                                cr = [];
                            }
                        }
                    }
                }

                return fights.map(rawFight => {
                    let msg = {};
                    for (var [k, v] of parsePlayaResponse(rawFight)) {
                        msg[k] = v.split(/[/,]/g).map(d => isNaN(d) ? d : Number(d));
                    }

                    return msg;
                });
            }

            function importHAR (json) {
                for (let msg of findFightsInJSON(json)) {
                    if (msg['fighters'] && msg['winnerid'] && msg['r'] && Object.values(FIGHT_TYPES).includes(msg['fighters'][0])) {
                        var fightType = msg['fighters'][0];

                        // Fighter A (always a player)
                        var fighterA = new SFFighter(msg['fighters'].slice(5, 52));
                        if (fighterA.isMonster()) {
                            fighterA.Name = getFightTargetName(fightType, fighterA.Name, fighterA.getMonsterID());
                        }

                        // Fighter B (player or monster)
                        var fighterB = new SFFighter(msg['fighters'].slice(52, 99));
                        if (fighterB.isMonster() || !isNaN(fighterB.Name)) {
                            fighterB.Name = getFightTargetName(fightType, fighterB.Name, fighterB.getMonsterID())
                        }

                        // Winner
                        var winner = msg['winnerid'][0] == fighterA.ID ? fighterA : fighterB;

                        // Looping though all rounds
                        let slices = [];
                        for (let i = 0; i < msg['r'].length / 3; i++) {
                            slices.push(msg['r'].slice(i * 3, i * 3 + 3));
                        }

                        let rounds = [];
                        for (let [attackerID, attackType, targetHealthLeft] of slices) {
                            rounds.push({
                                attackType,
                                targetHealthLeft,
                                attacker: attackerID == fighterA.ID ? fighterA : fighterB,
                                target: attackerID == fighterA.ID ? fighterB : fighterA,
                                attackSecondary: attackType <= 100 && (attackType >= 10 && attackType <= 14),
                                attackCrit: attackType <= 100 && (attackType % 10 == 1),
                                attackMissed: attackType <= 100 && ((attackType % 10 == 3) || (attackType % 10 == 4)),
                                attackDamage: 0
                            });
                        }

                        let findPlayerHealth = (i) => {
                            let currentRound = rounds[i];
                            for (let j = i - 1, round; round = rounds[j]; j--) {
                                if (round.attacker == currentRound.attacker && round.attackType < 100) {
                                    return round.targetHealthLeft;
                                }
                            }

                            return currentRound.target.Life;
                        }

                        for (let i = 0, round; round = rounds[i]; i++) {
                            if (round.attackType < 100) {
                                round.attackDamage = findPlayerHealth(i) - round.targetHealthLeft;
                            } else {
                                round.attackDamage = round.targetHealthLeft;
                            }
                        }

                        fightData.push({
                            fighterA: fighterA,
                            fighterB: fighterB,
                            rounds: rounds,
                            winner: winner
                        });
                    }
                }
            }

            function getID (a, b) {
                return SHA1(JSON.stringify([
                    a.ID,
                    a.Name,
                    a.Class,
                    a.Strength,
                    a.Dexterity,
                    a.Intelligence,
                    a.Constitution,
                    a.Luck,
                    a.MaximumLife,
                    a.Mask,
                    a.Instrument,
                    a.Wpn1,
                    a.Wpn2
                ]) + JSON.stringify([
                    b.ID,
                    b.Name,
                    b.Class,
                    b.Strength,
                    b.Dexterity,
                    b.Intelligence,
                    b.Constitution,
                    b.Luck,
                    b.MaximumLife,
                    b.Mask,
                    b.Instrument,
                    b.Wpn1,
                    b.Wpn2
                ]));
            }

            function getDamages () {
                var ranges = {};

                for (var fight of fightData) {
                    var rounds = fight.rounds;
                    var offset = 0;

                    for (var i = 0; i < rounds.length; i++) {
                        var round = rounds[i];

                        if (round.attackType >= 100) {
                            offset--;
                        } else {
                            if (round.attackType >= 20) {
                                offset++;
                            }

                            if (round.attackType % 10 == 0 || round.attackType % 10 == 1) {
                                var id = getID(round.attacker, round.target) + (round.attackType >= 10 && round.attackType <= 14 ? '_2' : '');
                                var rage = 1 + (i + offset) / 6;
                                var damage = Math.trunc(round.attackDamage / rage);

                                if (!ranges[id]) {
                                    ranges[id] = { };
                                }

                                if (round.attackCrit) {
                                    if (!ranges[id].crit) {
                                        ranges[id].crit = {
                                            min: damage,
                                            max: damage
                                        }
                                    } else {
                                        ranges[id].crit.min = Math.min(damage, ranges[id].crit.min);
                                        ranges[id].crit.max = Math.max(damage, ranges[id].crit.max);
                                    }
                                } else {
                                    if (!ranges[id].normal) {
                                        ranges[id].normal = {
                                            min: damage,
                                            max: damage
                                        }
                                    } else {
                                        ranges[id].normal.min = Math.min(damage, ranges[id].normal.min);
                                        ranges[id].normal.max = Math.max(damage, ranges[id].normal.max);
                                    }
                                }
                            }
                        }
                    }
                }

                return ranges;
            }

            function getBaseDamage ({ Class, Level }, secondary = false) {
                let min = 1;
                let max = 2;

                if (Level > 10) {
                    let num = Level - 10;

                    if (Class == 1 || Class == 5 || Class == 6) {
                        num = 2.0 * (1 + num)
                    } else if (Class == 3 || Class == 4 || Class == 7) {
                        num = 2.5 * (1 + num)
                    } else {
                        num = 4.5 * (1 + num)
                    }

                    num = Math.trunc(num)
                    min = num - num / 3
                    max = num + num / 3

                    if (secondary) {
                        min = Math.trunc(min * 0.1);
                        max = Math.trunc(max * 0.1);
                    } else {
                        min = Math.trunc(min * 0.7);
                        max = Math.trunc(max * 0.7);
                    }
                }

                return {
                    Min: Math.max(1, min),
                    Max: Math.max(2, max)
                }
            }
        </script>
    </body>
</html>
